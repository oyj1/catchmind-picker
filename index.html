<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>캐치마인드 단어 뽑기 · V3</title>
<style>
  :root{
    --bg:#fff3e0; --card:#ffffff; --text:#222; --muted:#5b5b5b;
    --brand:#6C63FF; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --shadow:0 16px 32px rgba(15,23,42,.12); --chip:#f4f4ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-rounded, "Pretendard","Apple SD Gothic Neo","Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background: radial-gradient(1200px 700px at 20% 0%, #fff 0%, #fff5e8 55%, var(--bg) 100%);
    color:var(--text);
  }
  .app{max-width:1000px; margin:0 auto; padding:20px}
  header{display:flex; align-items:center; gap:14px; margin-bottom:12px; flex-wrap:wrap}
  .logo{width:48px;height:48px;border-radius:14px;background:
    conic-gradient(from 0deg,#ff7eb3,#ffbd59,#f9f871,#8cfac6,#7ad3ff,#c3a6ff,#ff7eb3);
    display:grid;place-items:center;box-shadow:var(--shadow);font-weight:900}
  h1{margin:0; font-size:clamp(20px,2.4vw,28px)}
  .sub{color:var(--muted)}
  .grid{display:grid; gap:14px}
  @media(min-width:860px){ .grid{grid-template-columns: 1fr 1fr} }
  .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow)}
  .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .row{display:flex; flex-wrap:wrap; gap:8px}
  button{
    border:0; background:var(--brand); color:#fff; padding:12px 16px; border-radius:14px; font-weight:900;
    cursor:pointer; box-shadow:var(--shadow); font-size:16px; transition:transform .2s ease, filter .2s ease, box-shadow .2s ease;
  }
  button:hover{filter:brightness(1.03)}
  button.ghost{background:#fff;color:#333; border:1px solid #e5e7eb}
  button.ok{background:var(--ok)} .button.warn{background:var(--warn)} .button.danger{background:var(--danger)}
  select, input[type="text"], input[type="number"], textarea{
    padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; font-size:16px;
  }
  label{display:flex; align-items:center; gap:6px}
  .chip{background:var(--chip); border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px; font-weight:700}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  /* Primary CTA */
  .cta{display:grid; gap:12px; place-items:center; padding:10px 0}
  .cta button#pick{
    background:linear-gradient(135deg,#00c853,#a5d6a7);
    font-size: clamp(22px, 3.2vw, 28px);
    padding: 18px 32px;
    border-radius:999px;
    box-shadow:0 18px 32px rgba(0,200,83,.25);
    display:inline-flex;
    align-items:center;
    gap:12px;
  }
  .cta button#pick:hover{
    transform:scale(1.04);
    box-shadow:0 22px 36px rgba(0,200,83,.28);
  }
  .cta button#pick:active{transform:scale(0.98);}
  .cta button#pick .label{letter-spacing:.02em}
  .cta button#pick .dice{display:inline-flex; font-size:1.3em; transition:transform .3s ease}
  .cta button#pick:hover .dice{animation:dice-spin .8s ease-in-out infinite}
  @keyframes dice-spin{
    0%{transform:rotate(0deg) scale(1)}
    50%{transform:rotate(18deg) scale(1.1)}
    100%{transform:rotate(0deg) scale(1)}
  }
  /* Big Reveal Overlay */
  .reveal{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background: radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.98), rgba(255,245,230,.98)); z-index:50}
  .reveal.active{display:flex}
  .reveal-box{text-align:center; padding:28px; border-radius:24px; background:#fff; border:2px solid #f1e5ff; box-shadow:0 30px 60px rgba(0,0,0,.18); max-width:90vw}
  .word{font-weight:1000; line-height:1.05; letter-spacing:-0.5px; font-size: clamp(52px, 9vw, 140px);
    background: linear-gradient(90deg,#7ad3ff,#c3a6ff,#ff7eb3,#ffbd59,#8cfac6); -webkit-background-clip:text; background-clip:text; color:transparent}
  .tiny{color:var(--muted); margin-top:6px}
  .big-controls{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px}
  /* Timer */
  .timer-card .timer-layout{display:grid; gap:14px}
  .timer-top{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}
  .timer-top .preset{flex:1 1 auto; justify-content:flex-start}
  .timer-top label{flex:0 0 auto}
  #sec{width:110px}
  .timer{ font-variant-numeric: tabular-nums; font-size:48px; font-weight:900; display:flex; gap:12px; align-items:center; justify-content:center; }
  .timer-display{display:grid; gap:10px}
  .timer-bottom{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
  .bar{height:12px; background:#eef2ff; border-radius:999px; overflow:hidden;}
  .bar>i{display:block; height:100%; width:100%; background:linear-gradient(90deg,#34d399,#60a5fa)}
  .preset{display:flex; gap:8px; flex-wrap:wrap}
  .preset button{background:#fff; color:#333; border:1px solid #e5e7eb}
  .preset button.active{background:#e8e8ff}
  @media(max-width:600px){
    .timer-top{flex-direction:column; align-items:flex-start}
    .timer-top label{width:100%}
    .timer-top label input{width:100%}
    #sec{width:100%}
  }
  /* History */
  .history{display:flex; flex-direction:column; gap:12px}
  .history .list{display:flex; flex-wrap:wrap; gap:6px; max-height:140px; overflow:auto}
  .history-actions{display:flex; flex-wrap:wrap; gap:10px}
  #undo{background:linear-gradient(135deg,#6366f1,#8b5cf6)}
  #undo:hover{box-shadow:0 18px 32px rgba(99,102,241,.28)}
  #resetUsed{background:#fff; color:#ef4444; border:1px solid rgba(239,68,68,.35); box-shadow:none}
  #resetUsed:hover{background:rgba(239,68,68,.08)}
  .token{background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-weight:700}
  /* Settings Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:60}
  .modal.active{display:flex}
  .modal .box{background:#fff; width:min(920px, 94vw); max-height:86vh; overflow:auto; border-radius:16px; border:1px solid #e5e7eb; box-shadow:var(--shadow); padding:14px}
  .modal .top{display:flex; justify-content:space-between; align-items:center; gap:10px; position:sticky; top:0; background:#fff; padding:6px 0}
  textarea{width:100%; min-height:160px}
  .header-actions{margin-left:auto; display:flex; gap:0; align-items:center; padding:4px; border-radius:999px; background:rgba(255,255,255,.7); border:1px solid rgba(255,255,255,.7); box-shadow:var(--shadow)}
  .header-actions button{background:transparent; color:var(--muted); border-radius:999px; padding:10px 18px; font-weight:700; box-shadow:none}
  .header-actions button:hover{background:rgba(255,255,255,.95); color:var(--text); filter:brightness(1.08)}
  footer{margin:14px 0 6px; color:var(--muted); font-size:13px; text-align:center}
  kbd{background:#f4f4ff;border:1px solid #e5e7eb;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-weight:800}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">🎨</div>
    <div>
      <h1>캐치마인드 단어 뽑기</h1>
      <div class="sub">아이패드·빔프로젝터 OK · 단어 크게 · 알록달록</div>
    </div>
    <div class="header-actions">
      <button id="openSettings">설정</button>
      <button id="fullscreen">전체 화면</button>
    </div>
  </header>

  <!-- Primary: Picker -->
  <section class="card">
    <div class="controls" style="justify-content:space-between">
      <div class="row">
        <label>언어
          <select id="lang">
            <option value="ko">한국어</option>
            <option value="en">English</option>
          </select>
        </label>
        <label>카테고리
          <select id="cat"></select>
        </label>
        <label><input id="norepeat" type="checkbox" checked /> 이미 나온 단어 제외</label>
        <label><input id="autotimer" type="checkbox" checked /> 공개 시 타이머 자동 시작</label>
        <label>🔊 <input id="sound" type="checkbox" checked /></label>
      </div>
      <div class="row">
        <span class="chip">총 <b id="poolCount">0</b>개 · 남은 <b id="remainCount">0</b>개</span>
        <span class="chip">최근: <b id="lastWord">-</b></span>
      </div>
    </div>

    <div class="cta">
      <button id="pick">
        <span class="label">단어 뽑기</span>
        <span class="dice" aria-hidden="true">🎲</span>
      </button>
      <div class="sub">단축키: <kbd>Space</kbd> 뽑기 · <kbd>N</kbd> 다음 · <kbd>Esc</kbd> 닫기 · <kbd>F</kbd> 전체화면 · <kbd>1/2/3/4</kbd> 프리셋</div>
    </div>
  </section>

  <div class="grid">
    <!-- Timer -->
    <section class="card timer-card">
      <h3 style="margin:0 0 8px 0">타이머</h3>
      <div class="timer-layout">
        <div class="timer-top" aria-label="타이머 프리셋">
          <div class="preset">
            <button data-sec="30">30초</button>
            <button data-sec="60">1분</button>
            <button data-sec="180">3분</button>
            <button data-sec="300">5분</button>
          </div>
          <label>초 <input id="sec" type="number" min="5" max="600" value="30"></label>
        </div>
        <div class="timer-display">
          <div class="timer"><span id="clock">00:30</span></div>
          <div class="bar"><i id="bar" style="transform:scaleX(1)"></i></div>
        </div>
        <div class="timer-bottom" aria-label="타이머 제어">
          <button id="tStart" class="ok">시작</button>
          <button id="tPause" class="ghost">일시정지</button>
          <button id="tReset" class="ghost">리셋</button>
        </div>
      </div>
    </section>

    <!-- History -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">히스토리</h3>
      <div class="history">
        <div class="history-actions">
          <button id="undo">되돌리기(마지막 단어 복구)</button>
          <button id="resetUsed" class="ghost">사용 기록 초기화</button>
        </div>
        <div id="histList" class="list" aria-label="최근 단어"></div>
      </div>
    </section>
  </div>

  <footer>© 2025 CatchMind Kit V3 · 로컬 저장(localStorage) · 오프라인 사용 가능</footer>
</div>

<!-- Big Reveal Overlay -->
<div class="reveal" id="reveal" aria-live="assertive">
  <div class="reveal-box">
    <div id="bigWord" class="word">단어</div>
    <div class="tiny" id="metaTiny">카테고리 - 언어</div>
    <div class="big-controls">
      <button id="closeReveal" class="ghost">닫기</button>
      <button id="nextWord" class="ok">다음 단어</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settings">
  <div class="box">
    <div class="top">
      <h3 style="margin:0">설정 · 단어 편집/저장/불러오기</h3>
      <div class="row">
        <button id="importLib" class="ghost">불러오기</button>
        <button id="exportLib" class="ghost">내보내기</button>
        <button id="closeSettings" class="ghost">닫기</button>
      </div>
    </div>
    <div class="controls" style="margin:6px 0">
      <span class="chip">현재 단어 <b id="libCount">0</b>개</span>
      <label>언어
        <select id="setLang">
          <option value="ko">한국어</option>
          <option value="en">English</option>
        </select>
      </label>
      <label>포맷
        <select id="fmt">
          <option value="csv">CSV/쉼표+줄바꿈</option>
          <option value="json">JSON</option>
        </select>
      </label>
      <button id="saveLib" class="ok">저장 (로컬)</button>
    </div>
    <div class="controls" style="gap:8px; flex-wrap:wrap; margin:6px 0 10px 0">
      <label><input id="mergeMode" type="checkbox" checked /> 기존 데이터에 <b>병합</b> (해제 시 <b>교체</b>)</label>
      <label class="chip">파일 불러오기(CSV/JSON)
        <input id="fileInput" type="file" accept=".csv,.json" />
      </label>
      <div class="row" style="gap:6px">
        <input id="urlSrc" type="text" placeholder="/data/ko.csv 또는 https://.../ko.json" style="min-width:360px">
        <button id="fetchUrl" class="ghost">URL에서 불러오기</button>
      </div>
    </div>
    <textarea id="editor" placeholder="CSV는 '카테고리,단어' 형식도 허용합니다. JSON은 {카테고리:[단어,...]} 형태"></textarea>
  </div>
</div>

<script>
// ===== Word Banks (ko/en) =====
const bank = {
  ko: {
    "동물":[
      "고양이","강아지","토끼","사자","호랑이","코끼리","기린","원숭이","판다","펭귄",
      "돌고래","상어","문어","거북이","개구리","나비","벌","부엉이","참새","여우",
      "늑대","돼지","소","말","양","염소","닭","독수리","두루미","하마",
      "코뿔소","캥거루","코알라","치타","표범","물개","바다사자","수달","다람쥐","고래"
    ],
    "음식":[
      "피자","햄버거","치킨","떡볶이","라면","김밥","초밥","파스타","샐러드","불고기",
      "비빔밥","만두","김치","탕수육","케이크","쿠키","도넛","아이스크림","사과","바나나",
      "잡채","갈비","삼겹살","순두부찌개","김치찌개","된장찌개","쌈밥","냉면","비빔국수","칼국수",
      "호떡","붕어빵","떡갈비","계란말이","쭈꾸미볶음","감자튀김","핫도그","김치전","해물파전","토스트"
    ],
    "사물":[
      "연필","지우개","책","가방","자","가위","컵","접시","시계","안경",
      "의자","책상","침대","컴퓨터","키보드","마우스","전화기","모니터","우산","달력",
      "손전등","리모컨","칫솔","빗","우체통","쓰레기통","열쇠","볼펜","노트","이어폰",
      "카메라","거울","텐트","배터리","충전기","도장","분리수거봉투","젓가락","포스트잇","테이프"
    ],
    "장소":[
      "학교","병원","은행","도서관","공원","해변","산","동물원","수족관","식당",
      "카페","영화관","놀이공원","집","아파트","역","공항","도로","다리","터널",
      "시장","마트","편의점","체육관","미술관","박물관","경기장","버스정류장","지하철역","놀이터",
      "공장","사무실","회의실","옥상","주차장","서점","빵집","노을공원","한강","캠핑장"
    ],
    "놀이":[
      "축구","야구","농구","배구","테니스","탁구","배드민턴","수영","줄넘기","숨바꼭질",
      "술래잡기","그네","시소","미끄럼틀","보드게임","퍼즐","로봇","카드","팽이","윷놀이",
      "자전거","스케이트","킥보드","눈싸움","모래성쌓기","연날리기","제기차기","피구","오목","장기",
      "체스","퍼즐큐브","딱지치기","풍선터뜨리기","박스썰매","방방","사방치기","팔씨름","팔찌만들기","스캐빈저헌트"
    ],
    "직업":[
      "선생님","의사","간호사","경찰","소방관","요리사","가수","배우","운동선수","화가",
      "작가","과학자","엔지니어","프로그래머","디자이너","건축가","파일럿","유튜버","군인","농부",
      "제빵사","바리스타","사진가","기자","약사","수의사","판사","변호사","회계사","번역가",
      "댄서","게임개발자","애니메이터","데이터분석가","마케터","UX디자이너","PM","승무원","해양구조대원","환경미화원"
    ],
    "자연":[
      "해","달","별","구름","비","눈","바람","무지개","꽃","나무",
      "바다","강","호수","폭포","섬","산","화산","사막","동굴","언덕",
      "계곡","들판","초원","빙하","해일","파도","이끼","모래","단풍","해무",
      "서리","안개","천둥","번개","별똥별","오로라","자갈","진흙","고드름","샘물"
    ],
    "속담":[
      "식은 죽 먹기",
      "구슬이 서 말이라도 꿰어야 보배",
      "가는 말이 고와야 오는 말이 곱다",
      "백지장도 맞들면 낫다",
      "고래 싸움에 새우 등 터진다",
      "개구리 올챙이 적 생각 못한다",
      "원숭이도 나무에서 떨어진다",
      "티끌 모아 태산",
      "돌다리도 두들겨 보고 건너라",
      "호랑이 굴에 가야 호랑이 새끼를 잡는다",
      "호미로 막을 것을 가래로 막는다",
      "가는 날이 장날",
      "등잔 밑이 어둡다",
      "세 살 버릇 여든까지 간다",
      "초지일관",
      "바늘 도둑이 소 도둑 된다",
      "빈 수레가 요란하다",
      "달걀로 바위 치기",
      "누워서 떡 먹기",
      "고생 끝에 낙이 온다",
      "남의 떡이 더 커 보인다",
      "뛰는 놈 위에 나는 놈 있다",
      "말 한마디에 천 냥 빚 갚는다",
      "우물 안 개구리",
      "열 번 찍어 안 넘어가는 나무 없다",
      "하나만 알고 둘은 모른다",
      "꿩 먹고 알 먹기",
      "그림의 떡",
      "땅 짚고 헤엄치기",
      "산 넘어 산",
      "소 잃고 외양간 고친다",
      "아니 땐 굴뚝에 연기 나랴",
      "믿는 도끼에 발등 찍힌다",
      "궁하면 통한다",
      "벼는 익을수록 고개를 숙인다",
      "백문이 불여일견",
      "낫 놓고 기역자도 모른다",
      "돌다리도 두들겨라",
      "윗물이 맑아야 아랫물이 맑다",
      "사공이 많으면 배가 산으로 간다"
    ]
  },
  en: {
    "Animals":[
      "cat","dog","rabbit","lion","tiger","elephant","giraffe","monkey","panda","penguin",
      "dolphin","shark","octopus","turtle","frog","butterfly","bee","owl","sparrow","fox",
      "wolf","pig","cow","horse","sheep","goat","chicken","eagle","crane","hippopotamus",
      "rhinoceros","kangaroo","koala","cheetah","leopard","seal","sea lion","otter","squirrel","whale"
    ],
    "Food":[
      "pizza","hamburger","chicken","tteokbokki","ramen","gimbap","sushi","pasta","salad","bulgogi",
      "bibimbap","dumpling","kimchi","sweet and sour pork","cake","cookie","donut","ice cream","apple","banana",
      "japchae","galbi","samgyeopsal","soft tofu stew","kimchi stew","soybean paste stew","ssambap","naengmyeon","bibim guksu","kalguksu",
      "hotteok","bungeoppang","tteokgalbi","rolled omelette","stir-fried baby octopus","french fries","hot dog","kimchi pancake","seafood green onion pancake","toast"
    ],
    "Objects":[
      "pencil","eraser","book","bag","ruler","scissors","cup","plate","clock","glasses",
      "chair","desk","bed","computer","keyboard","mouse","phone","monitor","umbrella","calendar",
      "flashlight","remote control","toothbrush","comb","mailbox","trash can","key","ballpoint pen","notebook","earphones",
      "camera","mirror","tent","battery","charger","stamp","recycling bag","chopsticks","sticky note","tape"
    ],
    "Places":[
      "school","hospital","bank","library","park","beach","mountain","zoo","aquarium","restaurant",
      "cafe","cinema","amusement park","home","apartment","station","airport","road","bridge","tunnel",
      "market","supermarket","convenience store","gymnasium","art museum","museum","stadium","bus stop","subway station","playground",
      "factory","office","meeting room","rooftop","parking lot","bookstore","bakery","sunset park","Han River","campsite"
    ],
    "Play":[
      "soccer","baseball","basketball","volleyball","tennis","table tennis","badminton","swimming","jump rope","hide-and-seek",
      "tag","swing","seesaw","slide","board game","puzzle","robot","card","top","yut",
      "bike riding","skating","kick scooter","snowball fight","building sandcastles","kite flying","jegichagi","dodgeball","omok","janggi",
      "chess","Rubik's cube","ddakji","balloon popping","box sledding","trampoline","hopscotch","arm wrestling","bracelet making","scavenger hunt"
    ],
    "Jobs":[
      "teacher","doctor","nurse","police","firefighter","chef","singer","actor","athlete","painter",
      "writer","scientist","engineer","programmer","designer","architect","pilot","youtuber","soldier","farmer",
      "baker","barista","photographer","journalist","pharmacist","veterinarian","judge","lawyer","accountant","translator",
      "dancer","game developer","animator","data analyst","marketer","UX designer","product manager","flight attendant","coast guard rescuer","sanitation worker"
    ],
    "Nature":[
      "sun","moon","star","cloud","rain","snow","wind","rainbow","flower","tree",
      "sea","river","lake","waterfall","island","mountain","volcano","desert","cave","hill",
      "valley","field","grassland","glacier","tsunami","wave","moss","sand","autumn leaves","sea fog",
      "frost","fog","thunder","lightning","shooting star","aurora","pebbles","mud","icicle","spring water"
    ],
    "Countries":[
      "South Korea","Japan","China","United States","United Kingdom","France","Germany","Italy","Spain","Russia",
      "Brazil","Argentina","Australia","New Zealand","India","Indonesia","Vietnam","Thailand","Philippines","Malaysia",
      "Singapore","Turkey","Greece","Egypt","Canada","Mexico","Saudi Arabia","South Africa","Netherlands","Sweden",
      "Switzerland","Denmark","Norway","Finland","Poland","Czech Republic","Israel","Iran","Chile","Peru","Kuwait"
    ],
    "Emotions":[
      "joy","sadness","anger","love","fear","embarrassment","surprise","loneliness","happiness","irritation",
      "worry","gratitude","remorse","butterflies","dread","regret","boredom","excitement","pride","disappointment",
      "amazement","tiredness","anticipation","courage","nervousness","anxiety","relief","hurt feelings","satisfaction","deeply moved",
      "frustration","enjoyment","annoyance","confidence","calmness","depression","jealousy","restlessness","lethargy"
    ],
    "Saying":[
      "piece of cake","pearls must be strung to be treasure","kind words bring kind words","even a sheet of paper is lighter together","when whales fight, the shrimp gets hurt",
      "the frog forgets its tadpole days","even monkeys fall from trees","dust piles up into a mountain","tap even a stone bridge before crossing","enter the tiger's den to catch a cub",
      "using a rake for what a hoe could stop","the day you go is market day","it's dark under the lamp","habits formed at three last until eighty","stay true to your first resolve",
      "a needle thief becomes a cow thief","an empty cart rattles loudly","like hitting a rock with an egg","eating rice cakes while lying down","joy comes after hardship",
      "other people's rice cakes look bigger","there's always someone better","a word repays a thousand nyang of debt","frog in a well","no tree withstands ten chops",
      "knows one but not two","eat the pheasant and its egg","rice cake in a picture","swimming with feet on the ground","mountain after mountain",
      "fix the barn after losing the cow","no smoke without fire","the trusted axe cuts your foot","when pressed, a way opens","the fuller the rice, the lower it bows",
      "seeing once beats hearing a hundred times","can't name even giyeok with a sickle","tap even the stone bridge","clear upstream makes clear downstream","too many boatmen steer the boat astray"
    ]
  }
};

// ===== State & Helpers =====
let lang = 'ko';
let used = new Set();
let history = []; // stack of picked words
let currentCat = '';
let pool = []; // words for selected cat (with '전체')
let lastWord = '-';

const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
function allWordsFor(langKey){
  const obj = bank[langKey]; return Object.values(obj).flat();
}
function updateCounts(){
  $('#poolCount').textContent = pool.length;
  const remain = pool.filter(w=>!used.has(w)).length;
  $('#remainCount').textContent = remain;
  $('#lastWord').textContent = lastWord;
}
function setCategories(){
  const catSel = $('#cat');
  catSel.innerHTML = '';
  const cats = Object.keys(bank[lang]);
  const options = ['전체', ...cats];
  for(const c of options){
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    catSel.appendChild(opt);
  }
  currentCat = '전체';
  catSel.value = currentCat;
  rebuildPool();
}
function rebuildPool(){
  pool = (currentCat==='전체')
    ? allWordsFor(lang)
    : (bank[lang][currentCat]||[]).slice();
  updateCounts();
}
function randPick(array){
  if(array.length===0) return null;
  const i = Math.floor(Math.random()*array.length);
  return array[i];
}

// ===== Picking & Reveal =====
let hue = 0;
function nextGradient(){
  hue = (hue + 37) % 360;
  return `linear-gradient(90deg, hsl(${hue} 90% 60%), hsl(${(hue+60)%360} 90% 65%), hsl(${(hue+120)%360} 90% 60%))`;
}
function showReveal(word){
  const big = $('#bigWord');
  big.textContent = word;
  big.style.backgroundImage = nextGradient();
  $('#metaTiny').textContent = `${currentCat} · ${lang==='ko'?'한국어':'English'}`;
  $('#reveal').classList.add('active');
}
function pickWord(){
  const norepeat = $('#norepeat').checked;
  let candidates = pool;
  if(norepeat){ candidates = pool.filter(w=>!used.has(w)); }
  if(candidates.length===0){
    alert('선택된 풀에서 모든 단어를 사용했습니다. 사용 기록을 초기화합니다.');
    used.clear(); history=[]; renderHistory(); candidates = pool.slice();
  }
  const w = randPick(candidates);
  if(!w) return;
  lastWord = w;
  history.push(w);
  renderHistory();
  if($('#sound').checked) ding();
  if($('#autotimer').checked) startTimer(true);
  showReveal(w);
  if(norepeat) used.add(w);
  updateCounts();
}
$('#pick').addEventListener('click', pickWord);
$('#closeReveal').addEventListener('click', ()=> $('#reveal').classList.remove('active'));
$('#nextWord').addEventListener('click', pickWord);

// ===== History & Undo =====
function renderHistory(){
  const box = $('#histList');
  box.innerHTML = history.slice(-40).map(w=>`<span class="token">${w}</span>`).join('');
}
$('#undo').addEventListener('click', ()=>{
  if(history.length===0) return;
  const w = history.pop();
  used.delete(w); // return to pool
  lastWord = history[history.length-1] || '-';
  renderHistory(); updateCounts();
});

$('#resetUsed').addEventListener('click', ()=>{ used.clear(); history=[]; renderHistory(); updateCounts(); });

// ===== Timer with Presets =====
let tHandle=null, tRemain=30, tTotal=30;
function fmt(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(Math.max(0,Math.floor(sec%60))).padStart(2,'0'); return `${m}:${s}`;}
function setRemain(v){
  tRemain = Math.max(0, v);
  $('#clock').textContent = fmt(tRemain);
  $('#bar').style.transform = `scaleX(${tRemain/tTotal})`;
}
function startTimer(fromPicker=false){
  if(tHandle) clearInterval(tHandle);
  tTotal = parseInt($('#sec').value||30,10);
  if(isNaN(tTotal)||tTotal<5) tTotal = 30;
  setRemain(tTotal);
  const start = performance.now();
  const step=()=>{
    const elapsed=(performance.now()-start)/1000;
    setRemain(tTotal - elapsed);
    if(tRemain<=0){
      clearInterval(tHandle); tHandle=null; setRemain(0); beep();
    }
  };
  tHandle = setInterval(step, 50);
}
function pauseTimer(){ if(tHandle){ clearInterval(tHandle); tHandle=null; } }
function resetTimer(){ pauseTimer(); tTotal=parseInt($('#sec').value||30,10); if(isNaN(tTotal)||tTotal<5) tTotal=30; setRemain(tTotal); }
function clickPreset(sec){
  $$('.preset button').forEach(x=>x.classList.remove('active'));
  const b = $$('.preset button').find(x=>x.dataset.sec===String(sec));
  if(b) b.classList.add('active');
  $('#sec').value = sec; resetTimer();
}
$$('.preset button').forEach(b=> b.addEventListener('click', ()=>{
  clickPreset(b.dataset.sec);
}));
resetTimer();

// ===== Sound =====
function ding(){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type='triangle'; o.frequency.value=740;
  o.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25);
  o.start(); o.stop(ctx.currentTime+0.27);
}
function beep(){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type='sine'; o.frequency.value=880;
  o.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.5);
  o.start(); o.stop(ctx.currentTime+0.52);
}

// ===== Fullscreen =====
$('#fullscreen').addEventListener('click', ()=>{
  const el = document.documentElement;
  if(!document.fullscreenElement){ el.requestFullscreen?.(); }
  else{ document.exitFullscreen?.(); }
});

// ===== Settings (modal) & Library =====
function serializeCSV(obj){
  const lines=[];
  for(const [cat,arr] of Object.entries(obj)){ for(const w of arr) lines.push(`${cat},${w}`); }
  return lines.join('\n');
}
function toJSONtext(obj){ return JSON.stringify(obj, null, 2); }
function parseCSV(text){
  const out={};
  for(const raw of text.split(/\r?\n/)){
    const line = raw.trim();
    if(!line) continue;
    const idx = line.indexOf(',');
    if(idx===-1){
      out["기타"] = out["기타"]||[];
      out["기타"].push(line);
      continue;
    }
    const cat = line.slice(0, idx).trim();
    let word = line.slice(idx+1).trim();
    if((word.startsWith('"') && word.endsWith('"')) || (word.startsWith("'") && word.endsWith("'"))){
      word = word.slice(1, -1);
    }
    if(!out[cat]) out[cat]=[];
    out[cat].push(word);
  }
  return out;
}
function refreshEditor(){
  const langKey = $('#setLang').value;
  const data = bank[langKey];
  $('#libCount').textContent = Object.values(data).reduce((a,b)=>a+b.length,0);
  const fmt = $('#fmt').value;
  $('#editor').value = (fmt==='csv') ? serializeCSV(data) : toJSONtext(data);
}

// Local storage load/save
(function initFromStorage(){
  const koSaved = localStorage.getItem('catchmind_ko');
  const enSaved = localStorage.getItem('catchmind_en');
  if(koSaved){ try{ bank.ko = JSON.parse(koSaved); }catch{} }
  if(enSaved){ try{ bank.en = JSON.parse(enSaved); }catch{} }
})();

// --- Repo 데이터 자동 로더 -----------------------------------------

// GitHub Pages(/catchmind-picker)와 Vercel(/) 모두 커버: 베이스 경로 자동 계산
const BASE = (()=>{
  const p = location.pathname;
  return p.startsWith('/catchmind-picker') ? '/catchmind-picker' : '';
})();

// 언어별로 불러올 파일 목록 (필요에 따라 추가/삭제)
const DATA_FILES = {
  ko: ['/data/ko.csv', '/data/ko_proverbs.csv'],  // ko_proverbs.csv가 없으면 그냥 스킵됨
  en: ['/data/en.csv']
};

// 버전 파일(선택): 값이 달라지면 강제 새로 로드
const VERSION_URL = '/data/version.json';

// 텍스트 로드
async function fetchText(path){
  const url = BASE + path + `?v=${Date.now()}`; // 캐시 무력화(서비스워커/브라우저 캐시 회피)
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error(`Fetch fail: ${url} ${res.status}`);
  return await res.text();
}

// JSON/CSV 자동 판별 → {카테고리:[단어,...]}
function parseUnknownToBank(text){
  try{
    return JSON.parse(text); // JSON이면 그대로 사용
  }catch{
    return parseCSV(text);   // 네 코드에 이미 있는 CSV 파서 사용
  }
}

// 병합(중복 제거)
function mergeBanks(a,b){
  const out = JSON.parse(JSON.stringify(a||{}));
  for(const [cat, arr] of Object.entries(b||{})){
    if(!out[cat]) out[cat] = [];
    const set = new Set(out[cat]);
    for(const w of arr) set.add(w);
    out[cat] = [...set];
  }
  return out;
}

// 버전 파일 읽기(없어도 OK)
async function fetchVersion(){
  try{
    const txt = await fetchText(VERSION_URL);
    return JSON.parse(txt); // 예: {"ko":"2025-10-27"}
  }catch{
    return null;
  }
}

// 파일들 순서대로 읽어서 병합
async function loadLangFromRepo(langKey, {merge=true} = {}){
  const files = DATA_FILES[langKey] || [];
  if(files.length===0) return false;

  let combined = merge ? (bank[langKey] || {}) : {};
  let loadedAny = false;

  for(const path of files){
    try{
      const txt = await fetchText(path);
      const obj = parseUnknownToBank(txt);
      combined = merge ? mergeBanks(combined, obj) : obj;
      loadedAny = true;
    }catch(e){
      // 파일이 없거나 404면 조용히 스킵
    }
  }

  if(loadedAny){
    bank[langKey] = combined;
    localStorage.setItem('catchmind_'+langKey, JSON.stringify(combined));
    return true;
  }
  return false;
}

// 초기 동기화: 버전 비교 → 필요 시 재로딩
async function initRepoSync(){
  const version = await fetchVersion(); // 없으면 null
  const metaKey = (k)=> 'catchmind_repo_ver_' + k;

  const tasks = [];
  for(const k of Object.keys(DATA_FILES)){
    const newVer = version?.[k] || null;
    const oldVer = localStorage.getItem(metaKey(k));

    const needReload =
      !localStorage.getItem('catchmind_'+k) ||   // 처음 방문
      (newVer && newVer !== oldVer);             // 버전이 변경됨

    if(needReload){
      tasks.push(
        loadLangFromRepo(k, {merge:true}).then(ok=>{
          if(ok && newVer) localStorage.setItem(metaKey(k), newVer);
        })
      );
    }
  }
  await Promise.all(tasks);

  // UI 갱신
  setCategories();
  updateCounts();
}

// 페이지 로드시 자동 실행(실패해도 기본 bank로 동작)
initRepoSync().catch(()=>{
  setCategories();
  updateCounts();
});

// ---------------------------------------------------------------

// Open/Close settings
$('#openSettings').addEventListener('click', ()=>{
  $('#setLang').value = lang;
  refreshEditor();
  $('#settings').classList.add('active');
});
$('#closeSettings').addEventListener('click', ()=> $('#settings').classList.remove('active'));

// Editor controls
$('#fmt').addEventListener('change', refreshEditor);
$('#setLang').addEventListener('change', refreshEditor);
$('#saveLib').addEventListener('click', ()=>{
  try{
    const langKey = $('#setLang').value;
    const fmt = $('#fmt').value;
    const text = $('#editor').value;
    const data = (fmt==='csv') ? parseCSV(text) : JSON.parse(text);
    bank[langKey] = data;
    localStorage.setItem('catchmind_'+langKey, JSON.stringify(data));
    if(lang===langKey){ setCategories(); }
    alert('저장 완료!');
  }catch(e){ alert('저장 실패: 형식을 확인해주세요.'); }
});
$('#importLib').addEventListener('click', ()=>{
  const text = prompt('붙여넣기( CSV 또는 JSON )');
  if(!text) return;
  try{
    let data;
    try{ data = JSON.parse(text); }
    catch{ data = parseCSV(text); }
    const langKey = $('#setLang').value;
    bank[langKey] = data;
    localStorage.setItem('catchmind_'+langKey, JSON.stringify(data));
    if(lang===langKey){ setCategories(); }
    refreshEditor();
    alert('불러오기 완료!');
  }catch(e){ alert('불러오기 실패: 형식을 확인해주세요.'); }
});
$('#exportLib').addEventListener('click', ()=>{
  const langKey = $('#setLang').value;
  const blob = new Blob([toJSONtext(bank[langKey])], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `catchmind_${langKey}.json`; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 500);
});

// UI Bindings for main picker
$('#lang').addEventListener('change', e=>{ lang = e.target.value; setCategories(); });
$('#cat').addEventListener('change', e=>{ currentCat = e.target.value; rebuildPool(); });
setCategories(); // init
updateCounts();

// ===== Keyboard Shortcuts =====
document.addEventListener('keydown', (e)=>{
  if(e.target.matches('input,textarea')) return;
  const k = e.key.toLowerCase();
  if(k===' '){ e.preventDefault(); pickWord(); }
  else if(k==='n'){ pickWord(); }
  else if(k==='escape'){ $('#reveal').classList.remove('active'); }
  else if(k==='f'){ const el=document.documentElement; if(!document.fullscreenElement){ el.requestFullscreen?.(); } else{ document.exitFullscreen?.(); } }
  else if(k==='1'){ clickPreset(30); }
  else if(k==='2'){ clickPreset(60); }
  else if(k==='3'){ clickPreset(180); }
  else if(k==='4'){ clickPreset(300); }
});

// === Import helpers ===
async function readFileText(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = () => res(String(r.result||''));
    r.onerror = rej;
    r.readAsText(file, 'utf-8');
  });
}

// 텍스트를 CSV/JSON으로 파싱 시도
function parseUnknown(text){
  let data;
  try{ data = JSON.parse(text); } catch{
    data = parseCSV(text);
  }
  return data;
}

// 공통 적용 함수(병합/교체 + 저장 + UI 갱신)
function applyImported(data, {langKey, merge}){
  if(merge){
    bank[langKey] = mergeBanks(bank[langKey], data);
  }else{
    bank[langKey] = data;
  }
  localStorage.setItem('catchmind_'+langKey, JSON.stringify(bank[langKey]));
  if(lang === langKey){ setCategories(); }
  refreshEditor();
  alert('불러오기 완료!');
}

// 파일 업로드
$('#fileInput').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const text = await readFileText(file);
    const data = parseUnknown(text);
    const merge = $('#mergeMode').checked;
    const langKey = $('#setLang').value;
    applyImported(data, {langKey, merge});
  }catch(err){
    console.error(err);
    alert('파일 불러오기 실패: 형식을 확인해주세요.');
  }finally{
    e.target.value = '';
  }
});

// URL에서 불러오기 (동일 출처 / CORS 허용 필요)
$('#fetchUrl').addEventListener('click', async ()=>{
  const url = ($('#urlSrc').value||'').trim();
  if(!url){ alert('URL을 입력해주세요.'); return; }
  try{
    // 캐시 무력화를 원하면 ?v=timestamp를 붙여도 됨
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const data = parseUnknown(text);
    const merge = $('#mergeMode').checked;
    const langKey = $('#setLang').value;
    applyImported(data, {langKey, merge});
    // 메타 저장(어디서 받았는지 기록)
    const meta = { url, lang: langKey, merged: merge, fetchedAt: new Date().toISOString() };
    localStorage.setItem('catchmind_meta_'+langKey, JSON.stringify(meta));
  }catch(err){
    console.error(err);
    alert('URL 불러오기 실패: CORS/경로/형식을 확인해주세요.');
  }
});
</script>
</body>
</html>
