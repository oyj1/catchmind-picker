<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìºì¹˜ë§ˆì¸ë“œ ë‹¨ì–´ ë½‘ê¸° Â· V3</title>
<style>
  :root{
    --bg:#fffaf5; --card:#ffffff; --text:#222; --muted:#5b5b5b;
    --brand:#6C63FF; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --shadow:0 10px 24px rgba(0,0,0,.08); --chip:#f4f4ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-rounded, "Pretendard","Apple SD Gothic Neo","Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background: radial-gradient(1200px 700px at 20% 0%, #fff 0%, #fff4e8 60%, #ffe9fb 100%);
    color:var(--text);
  }
  .app{max-width:1000px; margin:0 auto; padding:20px}
  header{display:flex; align-items:center; gap:14px; margin-bottom:12px; flex-wrap:wrap}
  .logo{width:48px;height:48px;border-radius:14px;background:
    conic-gradient(from 0deg,#ff7eb3,#ffbd59,#f9f871,#8cfac6,#7ad3ff,#c3a6ff,#ff7eb3);
    display:grid;place-items:center;box-shadow:var(--shadow);font-weight:900}
  h1{margin:0; font-size:clamp(20px,2.4vw,28px)}
  .sub{color:var(--muted)}
  .grid{display:grid; gap:14px}
  @media(min-width:860px){ .grid{grid-template-columns: 1fr 1fr} }
  .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow)}
  .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .row{display:flex; flex-wrap:wrap; gap:8px}
  button{
    border:0; background:var(--brand); color:#fff; padding:12px 16px; border-radius:14px; font-weight:900;
    cursor:pointer; box-shadow:var(--shadow); font-size:16px;
  }
  button.ghost{background:#fff;color:#333; border:1px solid #e5e7eb}
  button.ok{background:var(--ok)} .button.warn{background:var(--warn)} .button.danger{background:var(--danger)}
  select, input[type="text"], input[type="number"], textarea{
    padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; font-size:16px;
  }
  label{display:flex; align-items:center; gap:6px}
  .chip{background:var(--chip); border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px; font-weight:700}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  /* Primary CTA */
  .cta{display:grid; gap:12px; place-items:center; padding:10px 0}
  .cta button#pick{font-size: clamp(22px, 3.2vw, 28px); padding: 16px 24px; border-radius:18px; box-shadow:0 14px 26px rgba(108,99,255,.25)}
  /* Big Reveal Overlay */
  .reveal{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background: radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.98), rgba(255,245,230,.98)); z-index:50}
  .reveal.active{display:flex}
  .reveal-box{text-align:center; padding:28px; border-radius:24px; background:#fff; border:2px solid #f1e5ff; box-shadow:0 30px 60px rgba(0,0,0,.18); max-width:90vw}
  .word{font-weight:1000; line-height:1.05; letter-spacing:-0.5px; font-size: clamp(52px, 9vw, 140px);
    background: linear-gradient(90deg,#7ad3ff,#c3a6ff,#ff7eb3,#ffbd59,#8cfac6); -webkit-background-clip:text; background-clip:text; color:transparent}
  .tiny{color:var(--muted); margin-top:6px}
  .big-controls{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px}
  /* Timer */
  .timer{ font-variant-numeric: tabular-nums; font-size:48px; font-weight:900; display:flex; gap:12px; align-items:center; justify-content:center; }
  .bar{height:12px; background:#eef2ff; border-radius:999px; overflow:hidden; margin-top:8px}
  .bar>i{display:block; height:100%; width:100%; background:linear-gradient(90deg,#34d399,#60a5fa)}
  .preset{display:flex; gap:8px; flex-wrap:wrap}
  .preset button{background:#fff; color:#333; border:1px solid #e5e7eb}
  .preset button.active{background:#e8e8ff}
  /* History */
  .history{display:flex; flex-direction:column; gap:8px}
  .history .list{display:flex; flex-wrap:wrap; gap:6px; max-height:140px; overflow:auto}
  .token{background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-weight:700}
  /* Settings Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:60}
  .modal.active{display:flex}
  .modal .box{background:#fff; width:min(920px, 94vw); max-height:86vh; overflow:auto; border-radius:16px; border:1px solid #e5e7eb; box-shadow:var(--shadow); padding:14px}
  .modal .top{display:flex; justify-content:space-between; align-items:center; gap:10px; position:sticky; top:0; background:#fff; padding:6px 0}
  textarea{width:100%; min-height:160px}
  footer{margin:14px 0 6px; color:var(--muted); font-size:13px; text-align:center}
  kbd{background:#f4f4ff;border:1px solid #e5e7eb;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-weight:800}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">ğŸ¨</div>
    <div>
      <h1>ìºì¹˜ë§ˆì¸ë“œ ë‹¨ì–´ ë½‘ê¸°</h1>
      <div class="sub">ì•„ì´íŒ¨ë“œÂ·ë¹”í”„ë¡œì í„° OK Â· ë‹¨ì–´ í¬ê²Œ Â· ì•Œë¡ë‹¬ë¡</div>
    </div>
    <div style="margin-left:auto">
      <button id="openSettings" class="ghost">ì„¤ì •</button>
      <button id="fullscreen" class="ghost">ì „ì²´ í™”ë©´</button>
    </div>
  </header>

  <!-- Primary: Picker -->
  <section class="card">
    <div class="controls" style="justify-content:space-between">
      <div class="row">
        <label>ì–¸ì–´
          <select id="lang">
            <option value="ko">í•œêµ­ì–´</option>
            <option value="en">English</option>
          </select>
        </label>
        <label>ì¹´í…Œê³ ë¦¬
          <select id="cat"></select>
        </label>
        <label><input id="norepeat" type="checkbox" checked /> ì´ë¯¸ ë‚˜ì˜¨ ë‹¨ì–´ ì œì™¸</label>
        <label><input id="autotimer" type="checkbox" checked /> ê³µê°œ ì‹œ íƒ€ì´ë¨¸ ìë™ ì‹œì‘</label>
        <label>ğŸ”Š <input id="sound" type="checkbox" checked /></label>
      </div>
      <div class="row">
        <span class="chip">ì´ <b id="poolCount">0</b>ê°œ Â· ë‚¨ì€ <b id="remainCount">0</b>ê°œ</span>
        <span class="chip">ìµœê·¼: <b id="lastWord">-</b></span>
      </div>
    </div>

    <div class="cta">
      <button id="pick" class="ok">ë‹¨ì–´ ë½‘ê¸° ğŸ²</button>
      <div class="sub">ë‹¨ì¶•í‚¤: <kbd>Space</kbd> ë½‘ê¸° Â· <kbd>N</kbd> ë‹¤ìŒ Â· <kbd>Esc</kbd> ë‹«ê¸° Â· <kbd>F</kbd> ì „ì²´í™”ë©´ Â· <kbd>1/2/3/4</kbd> í”„ë¦¬ì…‹</div>
    </div>
  </section>

  <div class="grid">
    <!-- Timer -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">íƒ€ì´ë¨¸</h3>
      <div class="preset" aria-label="íƒ€ì´ë¨¸ í”„ë¦¬ì…‹">
        <button data-sec="30">30ì´ˆ</button>
        <button data-sec="60">1ë¶„</button>
        <button data-sec="180">3ë¶„</button>
        <button data-sec="300">5ë¶„</button>
      </div>
      <div class="controls" style="margin-top:8px">
        <label>ì´ˆ <input id="sec" type="number" min="5" max="600" value="30" style="width:110px"></label>
        <button id="tStart" class="ok">ì‹œì‘</button>
        <button id="tPause" class="ghost">ì¼ì‹œì •ì§€</button>
        <button id="tReset" class="ghost">ë¦¬ì…‹</button>
      </div>
      <div class="timer"><span id="clock">00:30</span></div>
      <div class="bar"><i id="bar" style="transform:scaleX(1)"></i></div>
    </section>

    <!-- History -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">íˆìŠ¤í† ë¦¬</h3>
      <div class="history">
        <div class="controls">
          <button id="undo" class="ghost">ë˜ëŒë¦¬ê¸°(ë§ˆì§€ë§‰ ë‹¨ì–´ ë³µêµ¬)</button>
          <button id="resetUsed" class="ghost">ì‚¬ìš© ê¸°ë¡ ì´ˆê¸°í™”</button>
        </div>
        <div id="histList" class="list" aria-label="ìµœê·¼ ë‹¨ì–´"></div>
      </div>
    </section>
  </div>

  <footer>Â© 2025 CatchMind Kit V3 Â· ë¡œì»¬ ì €ì¥(localStorage) Â· ì˜¤í”„ë¼ì¸ ì‚¬ìš© ê°€ëŠ¥</footer>
</div>

<!-- Big Reveal Overlay -->
<div class="reveal" id="reveal" aria-live="assertive">
  <div class="reveal-box">
    <div id="bigWord" class="word">ë‹¨ì–´</div>
    <div class="tiny" id="metaTiny">ì¹´í…Œê³ ë¦¬ - ì–¸ì–´</div>
    <div class="big-controls">
      <button id="closeReveal" class="ghost">ë‹«ê¸°</button>
      <button id="nextWord" class="ok">ë‹¤ìŒ ë‹¨ì–´</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settings">
  <div class="box">
    <div class="top">
      <h3 style="margin:0">ì„¤ì • Â· ë‹¨ì–´ í¸ì§‘/ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°</h3>
      <div class="row">
        <button id="importLib" class="ghost">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="exportLib" class="ghost">ë‚´ë³´ë‚´ê¸°</button>
        <button id="closeSettings" class="ghost">ë‹«ê¸°</button>
      </div>
    </div>
    <div class="controls" style="margin:6px 0">
      <span class="chip">í˜„ì¬ ë‹¨ì–´ <b id="libCount">0</b>ê°œ</span>
      <label>ì–¸ì–´
        <select id="setLang">
          <option value="ko">í•œêµ­ì–´</option>
          <option value="en">English</option>
        </select>
      </label>
      <label>í¬ë§·
        <select id="fmt">
          <option value="csv">CSV/ì‰¼í‘œ+ì¤„ë°”ê¿ˆ</option>
          <option value="json">JSON</option>
        </select>
      </label>
      <button id="saveLib" class="ok">ì €ì¥ (ë¡œì»¬)</button>
    </div>
    <div class="controls" style="gap:8px; flex-wrap:wrap; margin:6px 0 10px 0">
      <label><input id="mergeMode" type="checkbox" checked /> ê¸°ì¡´ ë°ì´í„°ì— <b>ë³‘í•©</b> (í•´ì œ ì‹œ <b>êµì²´</b>)</label>
      <label class="chip">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°(CSV/JSON)
        <input id="fileInput" type="file" accept=".csv,.json" />
      </label>
      <div class="row" style="gap:6px">
        <input id="urlSrc" type="text" placeholder="/data/ko.csv ë˜ëŠ” https://.../ko.json" style="min-width:360px">
        <button id="fetchUrl" class="ghost">URLì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
    <textarea id="editor" placeholder="CSVëŠ” 'ì¹´í…Œê³ ë¦¬,ë‹¨ì–´' í˜•ì‹ë„ í—ˆìš©í•©ë‹ˆë‹¤. JSONì€ {ì¹´í…Œê³ ë¦¬:[ë‹¨ì–´,...]} í˜•íƒœ"></textarea>
  </div>
</div>

<script>
// ===== Word Banks (ko/en) =====
const bank = {
  ko: {
    "ë™ë¬¼":["ê³ ì–‘ì´","ê°•ì•„ì§€","í† ë¼","ì‚¬ì","í˜¸ë‘ì´","ì½”ë¼ë¦¬","ê¸°ë¦°","ì›ìˆ­ì´","íŒë‹¤","í­ê·„","ëŒê³ ë˜","ìƒì–´","ë¬¸ì–´","ê±°ë¶ì´","ê°œêµ¬ë¦¬","ë‚˜ë¹„","ë²Œ","ë¶€ì—‰ì´","ì°¸ìƒˆ","ì—¬ìš°"],
    "ìŒì‹":["í”¼ì","í–„ë²„ê±°","ì¹˜í‚¨","ë–¡ë³¶ì´","ë¼ë©´","ê¹€ë°¥","ì´ˆë°¥","íŒŒìŠ¤íƒ€","ìƒëŸ¬ë“œ","ë¶ˆê³ ê¸°","ë¹„ë¹”ë°¥","ë§Œë‘","ê¹€ì¹˜","íƒ•ìˆ˜ìœ¡","ì¼€ì´í¬","ì¿ í‚¤","ë„ë„›","ì•„ì´ìŠ¤í¬ë¦¼","ì‚¬ê³¼","ë°”ë‚˜ë‚˜"],
    "ì‚¬ë¬¼":["ì—°í•„","ì§€ìš°ê°œ","ì±…","ê°€ë°©","ì","ê°€ìœ„","ì»µ","ì ‘ì‹œ","ì‹œê³„","ì•ˆê²½","ì˜ì","ì±…ìƒ","ì¹¨ëŒ€","ì»´í“¨í„°","í‚¤ë³´ë“œ","ë§ˆìš°ìŠ¤","ì „í™”ê¸°","ëª¨ë‹ˆí„°","ìš°ì‚°","ë‹¬ë ¥"],
    "ì¥ì†Œ":["í•™êµ","ë³‘ì›","ì€í–‰","ë„ì„œê´€","ê³µì›","í•´ë³€","ì‚°","ë™ë¬¼ì›","ìˆ˜ì¡±ê´€","ì‹ë‹¹","ì¹´í˜","ì˜í™”ê´€","ë†€ì´ê³µì›","ì§‘","ì•„íŒŒíŠ¸","ì—­","ê³µí•­","ë„ë¡œ","ë‹¤ë¦¬","í„°ë„"],
    "ë†€ì´":["ì¶•êµ¬","ì•¼êµ¬","ë†êµ¬","ë°°êµ¬","í…Œë‹ˆìŠ¤","íƒêµ¬","ë°°ë“œë¯¼í„´","ìˆ˜ì˜","ì¤„ë„˜ê¸°","ìˆ¨ë°”ê¼­ì§ˆ","ìˆ ë˜ì¡ê¸°","ê·¸ë„¤","ì‹œì†Œ","ë¯¸ë„ëŸ¼í‹€","ë³´ë“œê²Œì„","í¼ì¦","ë¡œë´‡","ì¹´ë“œ","íŒ½ì´","ìœ·ë†€ì´"],
    "ì§ì—…":["ì„ ìƒë‹˜","ì˜ì‚¬","ê°„í˜¸ì‚¬","ê²½ì°°","ì†Œë°©ê´€","ìš”ë¦¬ì‚¬","ê°€ìˆ˜","ë°°ìš°","ìš´ë™ì„ ìˆ˜","í™”ê°€","ì‘ê°€","ê³¼í•™ì","ì—”ì§€ë‹ˆì–´","í”„ë¡œê·¸ë˜ë¨¸","ë””ìì´ë„ˆ","ê±´ì¶•ê°€","íŒŒì¼ëŸ¿","ìœ íŠœë²„","êµ°ì¸","ë†ë¶€"],
    "ìì—°":["í•´","ë‹¬","ë³„","êµ¬ë¦„","ë¹„","ëˆˆ","ë°”ëŒ","ë¬´ì§€ê°œ","ê½ƒ","ë‚˜ë¬´","ë°”ë‹¤","ê°•","í˜¸ìˆ˜","í­í¬","ì„¬","ì‚°","í™”ì‚°","ì‚¬ë§‰","ë™êµ´","ì–¸ë•"]
  },
  en: {
    "Animals":["cat","dog","rabbit","lion","tiger","elephant","giraffe","monkey","panda","penguin","dolphin","shark","octopus","turtle","frog","butterfly","bee","owl","sparrow","fox"],
    "Food":["pizza","hamburger","chicken","tteokbokki","ramen","gimbap","sushi","pasta","salad","bulgogi","bibimbap","dumpling","kimchi","sweet and sour pork","cake","cookie","donut","ice cream","apple","banana"],
    "Objects":["pencil","eraser","book","bag","ruler","scissors","cup","plate","clock","glasses","chair","desk","bed","computer","keyboard","mouse","phone","monitor","umbrella","calendar"],
    "Places":["school","hospital","bank","library","park","beach","mountain","zoo","aquarium","restaurant","cafe","cinema","amusement park","home","apartment","station","airport","road","bridge","tunnel"],
    "Play":["soccer","baseball","basketball","volleyball","tennis","table tennis","badminton","swimming","jump rope","hide-and-seek","tag","swing","seesaw","slide","board game","puzzle","robot","card","top","yut"],
    "Jobs":["teacher","doctor","nurse","police","firefighter","chef","singer","actor","athlete","painter","writer","scientist","engineer","programmer","designer","architect","pilot","youtuber","soldier","farmer"],
    "Nature":["sun","moon","star","cloud","rain","snow","wind","rainbow","flower","tree","sea","river","lake","waterfall","island","mountain","volcano","desert","cave","hill"]
  }
};

// ===== State & Helpers =====
let lang = 'ko';
let used = new Set();
let history = []; // stack of picked words
let currentCat = '';
let pool = []; // words for selected cat (with 'ì „ì²´')
let lastWord = '-';

const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
function allWordsFor(langKey){
  const obj = bank[langKey]; return Object.values(obj).flat();
}
function updateCounts(){
  $('#poolCount').textContent = pool.length;
  const remain = pool.filter(w=>!used.has(w)).length;
  $('#remainCount').textContent = remain;
  $('#lastWord').textContent = lastWord;
}
function setCategories(){
  const catSel = $('#cat');
  catSel.innerHTML = '';
  const cats = Object.keys(bank[lang]);
  const options = ['ì „ì²´', ...cats];
  for(const c of options){
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    catSel.appendChild(opt);
  }
  currentCat = 'ì „ì²´';
  catSel.value = currentCat;
  rebuildPool();
}
function rebuildPool(){
  pool = (currentCat==='ì „ì²´')
    ? allWordsFor(lang)
    : (bank[lang][currentCat]||[]).slice();
  updateCounts();
}
function randPick(array){
  if(array.length===0) return null;
  const i = Math.floor(Math.random()*array.length);
  return array[i];
}

// ===== Picking & Reveal =====
let hue = 0;
function nextGradient(){
  hue = (hue + 37) % 360;
  return `linear-gradient(90deg, hsl(${hue} 90% 60%), hsl(${(hue+60)%360} 90% 65%), hsl(${(hue+120)%360} 90% 60%))`;
}
function showReveal(word){
  const big = $('#bigWord');
  big.textContent = word;
  big.style.backgroundImage = nextGradient();
  $('#metaTiny').textContent = `${currentCat} Â· ${lang==='ko'?'í•œêµ­ì–´':'English'}`;
  $('#reveal').classList.add('active');
}
function pickWord(){
  const norepeat = $('#norepeat').checked;
  let candidates = pool;
  if(norepeat){ candidates = pool.filter(w=>!used.has(w)); }
  if(candidates.length===0){
    alert('ì„ íƒëœ í’€ì—ì„œ ëª¨ë“  ë‹¨ì–´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì‚¬ìš© ê¸°ë¡ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.');
    used.clear(); history=[]; renderHistory(); candidates = pool.slice();
  }
  const w = randPick(candidates);
  if(!w) return;
  lastWord = w;
  history.push(w);
  renderHistory();
  if($('#sound').checked) ding();
  if($('#autotimer').checked) startTimer(true);
  showReveal(w);
  if(norepeat) used.add(w);
  updateCounts();
}
$('#pick').addEventListener('click', pickWord);
$('#closeReveal').addEventListener('click', ()=> $('#reveal').classList.remove('active'));
$('#nextWord').addEventListener('click', pickWord);

// ===== History & Undo =====
function renderHistory(){
  const box = $('#histList');
  box.innerHTML = history.slice(-40).map(w=>`<span class="token">${w}</span>`).join('');
}
$('#undo').addEventListener('click', ()=>{
  if(history.length===0) return;
  const w = history.pop();
  used.delete(w); // return to pool
  lastWord = history[history.length-1] || '-';
  renderHistory(); updateCounts();
});

$('#resetUsed').addEventListener('click', ()=>{ used.clear(); history=[]; renderHistory(); updateCounts(); });

// ===== Timer with Presets =====
let tHandle=null, tRemain=30, tTotal=30;
function fmt(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(Math.max(0,Math.floor(sec%60))).padStart(2,'0'); return `${m}:${s}`;}
function setRemain(v){
  tRemain = Math.max(0, v);
  $('#clock').textContent = fmt(tRemain);
  $('#bar').style.transform = `scaleX(${tRemain/tTotal})`;
}
function startTimer(fromPicker=false){
  if(tHandle) clearInterval(tHandle);
  tTotal = parseInt($('#sec').value||30,10);
  if(isNaN(tTotal)||tTotal<5) tTotal = 30;
  setRemain(tTotal);
  const start = performance.now();
  const step=()=>{
    const elapsed=(performance.now()-start)/1000;
    setRemain(tTotal - elapsed);
    if(tRemain<=0){
      clearInterval(tHandle); tHandle=null; setRemain(0); beep();
    }
  };
  tHandle = setInterval(step, 50);
}
function pauseTimer(){ if(tHandle){ clearInterval(tHandle); tHandle=null; } }
function resetTimer(){ pauseTimer(); tTotal=parseInt($('#sec').value||30,10); if(isNaN(tTotal)||tTotal<5) tTotal=30; setRemain(tTotal); }
function clickPreset(sec){
  $$('.preset button').forEach(x=>x.classList.remove('active'));
  const b = $$('.preset button').find(x=>x.dataset.sec===String(sec));
  if(b) b.classList.add('active');
  $('#sec').value = sec; resetTimer();
}
$$('.preset button').forEach(b=> b.addEventListener('click', ()=>{
  clickPreset(b.dataset.sec);
}));
resetTimer();

// ===== Sound =====
function ding(){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type='triangle'; o.frequency.value=740;
  o.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25);
  o.start(); o.stop(ctx.currentTime+0.27);
}
function beep(){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type='sine'; o.frequency.value=880;
  o.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.5);
  o.start(); o.stop(ctx.currentTime+0.52);
}

// ===== Fullscreen =====
$('#fullscreen').addEventListener('click', ()=>{
  const el = document.documentElement;
  if(!document.fullscreenElement){ el.requestFullscreen?.(); }
  else{ document.exitFullscreen?.(); }
});

// ===== Settings (modal) & Library =====
function serializeCSV(obj){
  const lines=[];
  for(const [cat,arr] of Object.entries(obj)){ for(const w of arr) lines.push(`${cat},${w}`); }
  return lines.join('\n');
}
function toJSONtext(obj){ return JSON.stringify(obj, null, 2); }
function parseCSV(text){
  const out={};
  for(const line of text.split(/\r?\n/)){
    const s=line.trim(); if(!s) continue;
    const parts=s.split(',').map(x=>x.trim()).filter(Boolean);
    if(parts.length===1){ out["ê¸°íƒ€"] = out["ê¸°íƒ€"]||[]; out["ê¸°íƒ€"].push(parts[0]); }
    else{ const [cat,word] = [parts[0], parts.slice(1).join(',')]; if(!out[cat]) out[cat]=[]; out[cat].push(word); }
  }
  return out;
}
function refreshEditor(){
  const langKey = $('#setLang').value;
  const data = bank[langKey];
  $('#libCount').textContent = Object.values(data).reduce((a,b)=>a+b.length,0);
  const fmt = $('#fmt').value;
  $('#editor').value = (fmt==='csv') ? serializeCSV(data) : toJSONtext(data);
}

// Local storage load/save
(function initFromStorage(){
  const koSaved = localStorage.getItem('catchmind_ko');
  const enSaved = localStorage.getItem('catchmind_en');
  if(koSaved){ try{ bank.ko = JSON.parse(koSaved); }catch{} }
  if(enSaved){ try{ bank.en = JSON.parse(enSaved); }catch{} }
})();

// Open/Close settings
$('#openSettings').addEventListener('click', ()=>{
  $('#setLang').value = lang;
  refreshEditor();
  $('#settings').classList.add('active');
});
$('#closeSettings').addEventListener('click', ()=> $('#settings').classList.remove('active'));

// Editor controls
$('#fmt').addEventListener('change', refreshEditor);
$('#setLang').addEventListener('change', refreshEditor);
$('#saveLib').addEventListener('click', ()=>{
  try{
    const langKey = $('#setLang').value;
    const fmt = $('#fmt').value;
    const text = $('#editor').value;
    const data = (fmt==='csv') ? parseCSV(text) : JSON.parse(text);
    bank[langKey] = data;
    localStorage.setItem('catchmind_'+langKey, JSON.stringify(data));
    if(lang===langKey){ setCategories(); }
    alert('ì €ì¥ ì™„ë£Œ!');
  }catch(e){ alert('ì €ì¥ ì‹¤íŒ¨: í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); }
});
$('#importLib').addEventListener('click', ()=>{
  const text = prompt('ë¶™ì—¬ë„£ê¸°( CSV ë˜ëŠ” JSON )');
  if(!text) return;
  try{
    let data;
    try{ data = JSON.parse(text); }
    catch{ data = parseCSV(text); }
    const langKey = $('#setLang').value;
    bank[langKey] = data;
    localStorage.setItem('catchmind_'+langKey, JSON.stringify(data));
    if(lang===langKey){ setCategories(); }
    refreshEditor();
    alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
  }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); }
});
$('#exportLib').addEventListener('click', ()=>{
  const langKey = $('#setLang').value;
  const blob = new Blob([toJSONtext(bank[langKey])], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `catchmind_${langKey}.json`; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 500);
});

// UI Bindings for main picker
$('#lang').addEventListener('change', e=>{ lang = e.target.value; setCategories(); });
$('#cat').addEventListener('change', e=>{ currentCat = e.target.value; rebuildPool(); });
setCategories(); // init
updateCounts();

// ===== Keyboard Shortcuts =====
document.addEventListener('keydown', (e)=>{
  if(e.target.matches('input,textarea')) return;
  const k = e.key.toLowerCase();
  if(k===' '){ e.preventDefault(); pickWord(); }
  else if(k==='n'){ pickWord(); }
  else if(k==='escape'){ $('#reveal').classList.remove('active'); }
  else if(k==='f'){ const el=document.documentElement; if(!document.fullscreenElement){ el.requestFullscreen?.(); } else{ document.exitFullscreen?.(); } }
  else if(k==='1'){ clickPreset(30); }
  else if(k==='2'){ clickPreset(60); }
  else if(k==='3'){ clickPreset(180); }
  else if(k==='4'){ clickPreset(300); }
});

// === Import helpers ===
async function readFileText(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = () => res(String(r.result||''));
    r.onerror = rej;
    r.readAsText(file, 'utf-8');
  });
}

// objAì™€ objB(ì¹´í…Œê³ ë¦¬:ë°°ì—´) ë³‘í•©: ì¤‘ë³µ ì œê±°
function mergeBanks(objA, objB){
  const out = JSON.parse(JSON.stringify(objA||{}));
  for(const [cat,arr] of Object.entries(objB||{})){
    if(!out[cat]) out[cat] = [];
    const set = new Set(out[cat]);
    for(const w of arr) set.add(w);
    out[cat] = [...set];
  }
  return out;
}

// í…ìŠ¤íŠ¸ë¥¼ CSV/JSONìœ¼ë¡œ íŒŒì‹± ì‹œë„
function parseUnknown(text){
  let data;
  try{ data = JSON.parse(text); } catch{
    data = parseCSV(text);
  }
  return data;
}

// ê³µí†µ ì ìš© í•¨ìˆ˜(ë³‘í•©/êµì²´ + ì €ì¥ + UI ê°±ì‹ )
function applyImported(data, {langKey, merge}){
  if(merge){
    bank[langKey] = mergeBanks(bank[langKey], data);
  }else{
    bank[langKey] = data;
  }
  localStorage.setItem('catchmind_'+langKey, JSON.stringify(bank[langKey]));
  if(lang === langKey){ setCategories(); }
  refreshEditor();
  alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
}

// íŒŒì¼ ì—…ë¡œë“œ
$('#fileInput').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const text = await readFileText(file);
    const data = parseUnknown(text);
    const merge = $('#mergeMode').checked;
    const langKey = $('#setLang').value;
    applyImported(data, {langKey, merge});
  }catch(err){
    console.error(err);
    alert('íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }finally{
    e.target.value = '';
  }
});

// URLì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ë™ì¼ ì¶œì²˜ / CORS í—ˆìš© í•„ìš”)
$('#fetchUrl').addEventListener('click', async ()=>{
  const url = ($('#urlSrc').value||'').trim();
  if(!url){ alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  try{
    // ìºì‹œ ë¬´ë ¥í™”ë¥¼ ì›í•˜ë©´ ?v=timestampë¥¼ ë¶™ì—¬ë„ ë¨
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const data = parseUnknown(text);
    const merge = $('#mergeMode').checked;
    const langKey = $('#setLang').value;
    applyImported(data, {langKey, merge});
    // ë©”íƒ€ ì €ì¥(ì–´ë””ì„œ ë°›ì•˜ëŠ”ì§€ ê¸°ë¡)
    const meta = { url, lang: langKey, merged: merge, fetchedAt: new Date().toISOString() };
    localStorage.setItem('catchmind_meta_'+langKey, JSON.stringify(meta));
  }catch(err){
    console.error(err);
    alert('URL ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: CORS/ê²½ë¡œ/í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }
});
</script>
</body>
</html>
